<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ght666.aiTools.mapper.ChatMessageMapper">

    <!-- 根据用户ID和会话ID查找消息列表 -->
    <select id="findByUserIdAndChatId" resultType="com.ght666.aiTools.entity.po.ChatMessage">
        SELECT * FROM chat_message
        WHERE user_id = #{userId} AND chat_id = #{chatId}
        ORDER BY created_time ASC
    </select>

    <!-- 根据会话ID查找最近的消息 -->
    <select id="findRecentByChatId" resultType="com.ght666.aiTools.entity.po.ChatMessage">
        SELECT * FROM chat_message
        WHERE chat_id = #{chatId}
        ORDER BY created_time DESC
            LIMIT #{limit}
    </select>

    <!-- 根据用户ID查找所有消息 -->
    <select id="findByUserId" resultType="com.ght666.aiTools.entity.po.ChatMessage">
        SELECT * FROM chat_message
        WHERE user_id = #{userId}
        ORDER BY created_time DESC
    </select>

    <!-- 删除会话的所有消息 -->
    <delete id="deleteByChatId">
        DELETE FROM chat_message
        WHERE chat_id = #{chatId}
    </delete>

    <!-- 删除用户的所有消息 -->
    <delete id="deleteByUserId">
        DELETE FROM chat_message
        WHERE user_id = #{userId}
    </delete>

    <!-- 统计会话消息数量 -->
    <select id="countByChatId" resultType="int">
        SELECT COUNT(*) FROM chat_message
        WHERE chat_id = #{chatId}
    </select>

    <!-- 根据时间范围查找消息 -->
    <select id="findByTimeRange" resultType="com.ght666.aiTools.entity.po.ChatMessage">
        SELECT * FROM chat_message
        WHERE user_id = #{userId}
          AND created_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY created_time DESC
    </select>

    <!-- 复杂查询：根据条件查找消息 -->
    <select id="findMessagesByCondition" resultType="com.ght666.aiTools.entity.po.ChatMessage">
        SELECT cm.*, u.username, u.nickname
        FROM chat_message cm
        LEFT JOIN user u ON cm.user_id = u.id
        <where>
            <if test="userId != null">
                AND cm.user_id = #{userId}
            </if>
            <if test="chatId != null and chatId != ''">
                AND cm.chat_id = #{chatId}
            </if>
            <if test="messageType != null and messageType != ''">
                AND cm.message_type = #{messageType}
            </if>
            <if test="role != null and role != ''">
                AND cm.role = #{role}
            </if>
            <if test="content != null and content != ''">
                AND cm.content LIKE CONCAT('%', #{content}, '%')
            </if>
            <if test="startTime != null">
                AND cm.created_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND cm.created_time <= #{endTime}
            </if>
        </where>
        ORDER BY cm.created_time DESC
    </select>

    <!-- 统计用户消息数量 -->
    <select id="countByUserId" resultType="int">
        SELECT COUNT(*) FROM chat_message
        WHERE user_id = #{userId}
    </select>

    <!-- 获取用户最近活跃时间 -->
    <select id="getLastActiveTime" resultType="java.time.LocalDateTime">
        SELECT MAX(created_time) FROM chat_message
        WHERE user_id = #{userId}
    </select>

</mapper>